/*! angular-d3-charts - v0.1.0 - 2014-05-23
* https://github.com/elesdoar/angular-d3-charts
* Copyright (c) 2014 ; Licensed MIT */
!function(){"use strict";angular.module("angular-d3-charts",[]).directive("a3bar",function(a,b,c,d,e){return{restrict:"EA",replace:!0,scope:{options:"=options",data:"=data"},template:'<div class="angular-a3bar"></div>',controller:function(b){a.info("[Angular - D3] Bar scope controller",b)},link:function(a,f,g){a.container=f,a.type="bar",a.classPrefix="a3bar";var h=b.isDefined,i=e.setDefaults(a.options,g.id),j=h(g.width)?g.width:i.width,k=h(g.height)?g.height:i.height;isNaN(j)?f.css("width",j):f.css("width",j+"px"),isNaN(k)?f.css("height",k):f.css("height",k+"px"),i.width=f.width(),i.height=f.height(),d.setXScale(a,i),d.setYScale(a,i),h(i.zoom)&&i.zoom&&c.addZoomBehaviour(a,d.zoomBehaviour),c.addSVG(a,f.get(0),i),f.width(i.containerWidth),f.height(i.containerHeight),d.addAxis(a,i),c.updateStyles(a,i),d.updateData(a,i)}}}),angular.module("angular-d3-charts").directive("a3oabar",function(a,b,c,d,e){return{restrict:"EA",replace:!0,scope:{options:"=options",data:"=data"},template:'<div class="angular-a3oabar"></div>',controller:function(b){a.info("[Angular - D3] One Axis Bar scope controller",b)},link:function(a,f,g){a.container=f,a.type="oneAxisBar",a.classPrefix="a3oabar";var h=b.isDefined,i=e.setDefaults(a.options,g.id),j=h(g.width)?g.width:i.width,k=h(g.height)?g.height:i.height;isNaN(j)?f.css("width",j):f.css("width",j+"px"),isNaN(k)?f.css("height",k):f.css("height",k+"px"),i.width=f.width(),i.height=f.height(),i.x.orient="bottom",d.setXScale(a,i),d.setYScale(a,i),h(i.zoom)&&i.zoom&&c.addZoomBehaviour(a,d.zoomBehaviour),c.addSVG(a,f.get(0),i),f.width(i.containerWidth),f.height(i.containerHeight),d.addOneAxis(a,i),c.updateStyles(a,i),d.updateData(a,i)}}}),angular.module("angular-d3-charts").factory("d3Helpers",function(a){function b(b,c){var d,e;if(angular.isDefined(c))d=c;else if(1===Object.keys(b).length)for(e in b)b.hasOwnProperty(e)&&(d=e);else 0===Object.keys(b).length?d="main":a.error("[AngularJS - D3] - You have more than 1 object on the DOM, you must provide the object ID");return d}function c(){return{width:300,heigth:250,zoom:!0,margin:{left:10,right:10,top:10,bottom:10},legend:{show:!0,width:120},timeFormat:"%d-%m-%Y",fontFamily:"Arial",fontSize:"0.75em",axis:{stroke:"#000",color:"#000",label:{color:"#000",fontWeight:"bold"},fontWeight:"normal"},showDefaultData:!0,locale:null}}return{isEmpty:function(a){return 0===Object.keys(a).length},isUndefinedOrEmpty:function(a){return angular.isUndefined(a)||null===a||0===Object.keys(a).length},isDefined:function(a){return angular.isDefined(a)&&null!==a},isNumber:function(a){return angular.isNumber(a)},isString:function(a){return angular.isString(a)},isArray:function(a){return angular.isArray(a)},isObject:function(a){return angular.isObject(a)},isFunction:function(a){return angular.isFunction(a)},equals:function(a,b){return angular.equals(a,b)},safeApply:function(a,b){var c=a.$root.$$phase;"$apply"===c||"$digest"===c?a.$eval(b):a.$apply(b)},getCommonDefaults:c,setDefaults:function(a,b){this.isDefined(b)&&(a.width=this.isDefined(b.width)?b.width:a.width,a.heigth=this.isDefined(b.heigth)?b.heigth:a.heigth,a.zoom=this.isDefined(b.zoom)?b.zoom:a.zoom,a.timeFormat=this.isDefined(b.timeFormat)?b.timeFormat:a.timeFormat,a.fontFamily=this.isDefined(b.fontFamily)?b.fontFamily:a.fontFamily,a.fontSize=this.isDefined(b.fontSize)?b.fontSize:a.fontSize,a.showDefaultData=this.isDefined(b.showDefaultData)?b.showDefaultData:a.showDefaultData,a.locale=this.isDefined(b.locale)?b.locale:a.locale,this.isDefined(b.margin)&&angular.extend(a.margin,b.margin),this.isDefined(b.legend)&&angular.extend(a.legend,b.legend),this.isDefined(b.axis)&&angular.extend(a.axis,b.axis))},getRandomString:function(a){for(var b="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz",c=a||8,d="",e=0;c>e;e++){var f=Math.floor(Math.random()*b.length);d+=b.substring(f,f+1)}return d},getRandomColor:function(){var a=Math.floor(256*Math.random()),b=Math.floor(256*Math.random()),c=Math.floor(256*Math.random());return d3.rgb(a,b,c)},obtainEffectiveChartId:b}}),angular.module("angular-d3-charts").factory("barDefaults",function(a,b){function c(){var c=a.getCommonDefaults();return angular.extend(c,{series:["A","B","C","D"],x:{tickFormat:null,tickSize:6,orient:"bottom",position:"bottom",key:"x",label:"x",ticks:5,tickSubdivide:4},y:{scale:"linear",tickFormat:null,tickSize:6,orient:"left",position:"left",key:"y",label:"y",ticks:5,tickSubdivide:4},axis:{valuesColor:"#000",percentColor:"#000",label:{color:"#000",fontWeight:"bold"}},defaultData:[{id:1,x:"Fruits",y:[54,0,879],tooltip:"Fruits tooltip"},{id:2,x:"Vegetables",y:[12,34,15],tooltip:"Vegetables tooltip"},{id:3,x:"Meet",y:[154,432,234],tooltip:"Meet tooltip"}]}),b.debug("[] Common defaults:",c),c}var d=a.isDefined,e=a.obtainEffectiveChartId,f={};return{getDefaults:function(a){var b=e(f,a);return f[b]},getCreationDefaults:function(a){var b=this.getDefaults(a),c={};return angular.extend(c,b),c},setDefaults:function(b,g){var h=c();d(b)&&(a.setDefaults(h,b),d(b.x)&&angular.extend(h.x,b.x),d(b.y)&&angular.extend(h.y,b.y),d(h.defaultData)&&angular.extend(h.defaultData,h.defaultData));var i=e(f,g);return f[i]=h,h}}}),angular.module("angular-d3-charts").factory("barHelpers",function(a,b,c){var d=function(a){return a.id},e=function(a,c){var d=null;return b.isUndefinedOrEmpty(a.data)&&c.showDefaultData&&!b.isUndefinedOrEmpty(c.defaultData)?d=c.defaultData:b.isString(a.data)||(d=a.data),d},f=function(c,d){if(c.xl=c.svg.append("g").attr("class","x axis"),c.xlLeftOffset=0,"left"===d.y.position&&(c.xlLeftOffset=30,"right"===d.y.orient&&(c.xlLeftOffset+=10)),!b.isDefined(d.x.position)||b.isString(d.x.position))switch(d.x.position){case"top":c.xl.attr("transform","translate("+c.xlLeftOffset+", "+("bottom"===d.x.orient?0:20)+")");break;default:b.isDefined(d.x.position)&&b.isString(d.x.position)&&"bottom"===d.x.position||(a.warn('[Angular - D3] X Axis position must be a string. Setting default value "bottom"'),d.x.position="bottom"),c.xl.attr("transform","translate("+c.xlLeftOffset+", "+(d.height+("bottom"===d.x.orient?0:20))+")")}else b.isNumber(d.x.position)&&c.xl.attr("transform","translate("+c.xlLeftOffset+", "+("bottom"===d.x.orient?d.x.position+20:d.x.position)+")");c.xl.call(c.xAxis),b.isDefined(d.x.label)&&d.x.label!==!1&&c.xl.append("text").attr("class","label").attr("transform","translate("+d.width+")").attr("dx","0.8em").attr("dy","bottom"===d.x.orient?"1.35em":0).style("text-anchor","start").style("font-size","1.1em").style("font-weight","bold").text(d.x.label)},g=function(c,d){if(c.yl=c.svg.append("g").attr("class","y axis"),c.ylTopOffset=0,"top"===d.x.position&&(c.ylTopOffset=30),!b.isDefined(d.y.position)||b.isString(d.y.position))switch(d.y.position){case"right":c.yl.attr("transform","translate("+(d.width+("left"===d.y.orient?20:0))+","+c.ylTopOffset+")");break;default:b.isDefined(d.y.position)&&b.isString(d.y.position)&&"left"===d.y.position||(a.warn('[Angular - D3] Y Axis position must be a string. Setting default value "left"'),d.y.position="left"),c.yl.attr("transform","translate("+("left"===d.y.orient?20:0)+","+c.ylTopOffset+")")}else b.isNumber(d.y.position)&&c.yl.attr("transform","translate("+(d.y.position-("left"===d.y.orient?20:0))+","+c.ylTopOffset+")");c.yl.call(c.yAxis),b.isDefined(d.y.label)&&d.y.label!==!1&&c.yl.append("text").attr("class","label").attr("dy","right"===d.y.position?4:"top"===d.x.position?0:"-1em").attr("x","right"===d.y.position?"1.5em":"1em").attr("y","top"===d.x.position?d.height:0).style("text-anchor","start").style("font-size","1.1em").style("font-weight","bold").text(d.y.label)};return{addAxis:function(a,b){f(a,b),g(a,b),this.addSubdivideTicks(a.yl,a.y,a.yAxis,b.y)},addOneAxis:function(a,b){f(a,b),a.ylTopOffset="top"===b.x.position?.125*b.height:.2*b.height,a.guide=a.svg.append("g").attr("class","guide"),a.guide.append("line").attr("x1",a.xlLeftOffset).attr("x2",b.width+a.xlLeftOffset).attr("y1",a.ylTopOffset-.03*b.height).attr("y2",a.ylTopOffset-.03*b.height).style("stroke","#BBB").style("stroke-width",1).style("shape-rendering","crispEdges")},addSubdivideTicks:function(a,b,c,d){if(a.selectAll(".tick.minor").classed("minor",!1).selectAll("text").style("display",null).style("stroke-width",0),"sqrt"===d.scale||"linear"===d.scale)switch(a.selectAll(".tick").data(b.ticks(d.ticks),function(a){return a}).exit().classed("minor",!0).selectAll("text").style("display","none"),c.orient()){case"left":a.selectAll(".tick.minor line").attr("x2",-4);break;case"bottom":a.selectAll(".tick.minor line").attr("y2",4);break;case"top":a.selectAll(".tick.minor line").attr("y2",-4);break;case"right":a.selectAll(".tick.minor line").attr("x2",4)}},setXScale:function(c,d){c.x=d3.scale.ordinal(),b.isDefined(c.xAxis)?c.xAxis.scale(c.x):((!b.isDefined(d.x.orient)||!b.isString(d.x.orient)||"bottom"!==d.x.orient&&"top"!==d.x.orient)&&(a.warn('[Angular - D3] Tick orient must be a string. Setting default value "bottom"'),d.x.orient="bottom"),c.xAxis=d3.svg.axis().scale(c.x).orient(d.x.orient)),b.isDefined(d.x.tickSize)&&b.isNumber(d.x.tickSize)?c.xAxis.tickSize(d.x.tickSize):(a.warn("[Angular - D3] Ticksize must be a number. Setting default value 6"),d.x.tickSize=6,c.xAxis.tickSize(d.x.tickSize));var f=e(c,d);c.x.domain(f.map(function(a){return a[d.x.key]})).rangeBands([0,d.width],.2),c.xAxis.tickFormat(d.x.tickFormat),b.isDefined(c.chartData)&&this.updateData(c.chartData)},setYScale:function(c,d){switch(d.y.scale){case"log":c.y=d3.scale.log().clamp(!0);break;case"sqrt":c.y=d3.scale.sqrt();break;case"time":c.y=d3.time.scale();break;default:"linear"!==d.y.scale&&(a.warn('[Angular - D3] Ticksize must be a string and ["linear", "log", "time", "sqrt"]. Setting default value "linear"'),d.y.scale="linear"),c.y=d3.scale.linear()}switch(c.y.range([0,d.height-("oneAxisBar"===c.type?.2*d.height:0)]),b.isDefined(c.yAxis)?c.yAxis.scale(c.y):(b.isDefined(d.y.orient)&&b.isString(d.y.orient)||(a.warn('[Angular - D3] Tick orient must be a string. Setting default value "left"'),d.y.orient="left"),c.yAxis=d3.svg.axis().scale(c.y).orient(d.y.orient)),b.isDefined(d.y.tickSize)&&b.isNumber(d.y.tickSize)?c.yAxis.tickSize(d.y.tickSize):(a.warn("[Angular - D3] Ticksize must be a number. Setting default value 6"),d.y.tickSize=6,c.yAxis.tickSize(d.y.tickSize)),d.y.scale){case"log":b.isDefined(d.y.tickFormat)||(d.y.tickFormat=function(a){var b=d3.round(Math.log(a)/Math.LN10,3);return b%1===0?a:""}),c.yAxis.ticks(d.y.ticks),c.y.domain([.1,1e3]);break;case"time":if(!b.isDefined(d.y.tickFormat)){var e=b.isDefined(d.locale)?d.locale.timeFormat:d3.time.format;d.y.tickFormat=e.multi([[".%L",function(a){return a.getMilliseconds()}],[":%S",function(a){return a.getSeconds()}],["%I:%M",function(a){return a.getMinutes()}],["%I %p",function(a){return a.getHours()}],["%a %d",function(a){return a.getDay()&&1!==a.getDate()}],["%b %d",function(a){return 1!==a.getDate()}],["%B",function(a){return a.getMonth()}],["%Y",function(){return!0}]])}c.yAxis.ticks(d.y.ticks);break;default:c.yAxis.ticks(d.y.ticks+d.y.ticks*d.y.tickSubdivide),c.y.domain([0,100])}c.yAxis.tickFormat(d.y.tickFormat),b.isDefined(c.data)&&this.updateData(c.data)},zoomBehaviour:function(){},updateData:function(f,g){var h=e(f,g);if(b.isUndefinedOrEmpty(h))return void a.warn("[Angular - D3] No data for bars");a.debug("[Angular - D3] Data for bars:",h);var i=d3.time.format(g.timeFormat),j=function(a){return a[g.y.key].map(function(b){return{x:a[g.x.key],y:b}})},k=h.map(function(a){return a[g.x.key]});f.x.domain(k).rangeBands([0,g.width],.2),a.debug("[Angular - D3] x domain:",k);var l=[],m=d3.min(h,function(a){return d3.min(a[g.y.key],function(a,c){return"time"!==g.y.scale||a instanceof Date||(a=i.parse(a)),b.isDefined(l[c])?l[c]+=a:l.push(a),a})});a.debug("[Angular - D3] Totals:",l),a.debug("[Angular - D3] Data min for bars:",m);var n=d3.max(h,function(a){return d3.max(a[g.y.key])});a.debug("[Angular - D3] Data max for bars:",n),void 0===m||void 0===n||0===m&&0===n?(m=0,n="time"===g.y.scale?new Date:100):m-n===0&&(m=m instanceof Date?0:m-Math.abs(m/2),n=n instanceof Date?n:n+Math.abs(n/2)),f.y.domain([m,n]),n>m&&f.y.nice(),"bar"===f.type&&(f.yl.call(f.yAxis),this.addSubdivideTicks(f.yl,f.y,f.yAxis,g.y)),b.isDefined(f.zoom)&&b.isDefined(g.zoom)&&g.zoom&&f.zoom.x(f.x).y(f.y);var o=d3.max(h.map(function(a){return a[g.y.key].length})),p=d3.scale.ordinal().domain(d3.range(o)).rangeRoundBands([0,f.x.rangeBand()]),q=f.svg.select("g."+f.classPrefix+"-bars");q.empty()&&(q=f.svg.append("g").attr("transform","translate("+f.xlLeftOffset+","+f.ylTopOffset+")").attr("class",f.classPrefix+"-bars").attr("clip-path","url(#"+f.idClip+")"));var r=q.selectAll("."+f.classPrefix+"-group-bar").data(h,d).interrupt(),s=r.enter().append("g").attr("class",f.classPrefix+"-group-bar"),t=s.selectAll("."+f.classPrefix+"-bar").data(j).interrupt().enter().append("rect").attr("class",f.classPrefix+"-bar"),u=d3.scale.category20();if(t.attr("width",p.rangeBand()).attr("x",function(a,b){return f.x(a.x)+p(b)}).attr("height",0).style("opacity",0).style("fill",function(a,b){var c=d3.rgb(u(b)),d=.5+a.y/n;return 1>=d?c.brighter(1-d):c.darker(d)}).transition().ease("cubic-in-out").duration(1e3).attr("height",function(a){return Math.abs(f.y(a.y)-f.y(0))}).style("opacity",1),"oneAxisBar"===f.type){var v=f.svg.select("g."+f.classPrefix+"-helptext");v.empty()&&(v=f.svg.append("g").attr("transform","translate("+f.xlLeftOffset+","+(f.ylTopOffset-("bottom"===g.x.position?.15*g.height:.85*-g.height))+")").attr("class",f.classPrefix+"-helptext"));var w=v.selectAll("."+f.classPrefix+"-values").data(h,d).interrupt();s=w.enter().append("g").attr("class",f.classPrefix+"-values"),s.selectAll("."+f.classPrefix+"-val").data(j).interrupt().enter().append("text").attr("x",function(a,b){return f.x(a.x)+p(b)+p.rangeBand()/2}).attr("class",f.classPrefix+"-val").style("text-anchor","middle").style("fill",g.axis.valuesColor).text(function(a){return a.y}),s.selectAll("."+f.classPrefix+"-percent").data(j).interrupt().enter().append("text").attr("x",function(a,b){return f.x(a.x)+p(b)+p.rangeBand()/2}).attr("y",.065*g.height).attr("class",f.classPrefix+"-percent").style("text-anchor","middle").style("font-size","0.85em").style("font-weight","bold").style("fill",g.axis.percentColor).text(function(a,b){var c=d3.format("%");return c(a.y/l[b])})}c.updateStyles(f,g)}}}),angular.module("angular-d3-charts").factory("svgHelpers",function(a,b){return{addSVG:function(a,c,d){var e=d.width+d.margin.left+d.margin.right;e+=d.legend.show?d.legend.width:0;var f=d.height+d.margin.top+d.margin.bottom+30;d.containerWidth=e,d.containerHeight=f;var g=d3.select(c).append("svg").attr("width",e).attr("height",f).append("g").attr("transform","translate("+d.margin.left+","+d.margin.top+")").style("cursor","pointer");return a.idClip="clip-"+b.getRandomString(),g.append("clipPath").attr("id",a.idClip).append("rect").attr("width",d.width-1).attr("height",d.height-20),a.svg=g,g},addZoomBehaviour:function(c,d){return b.isDefined(c.x)?b.isDefined(c.y)?void(c.zoom=d3.behavior.zoom().x(c.x).y(c.y).scaleExtent([.5,100]).on("zoom",d)):void a.warn("[Angular - D3] y scale is not defined, unable set zoom behavior"):void a.warn("[Angular - D3] x scale is not defined, unable set zoom behavior")},updateStyles:function(a,b){var c="bar"===a.type?b.axis.stroke:null;a.svg.selectAll(".axis path").style("stroke",c).style("fill","none").style("shape-rendering","crispEdges"),a.svg.selectAll(".axis .tick line").style("stroke",c).style("fill","none"),a.svg.selectAll(".axis .tick.minor").style("stroke",c).style("fill","none"),a.svg.selectAll(".axis text").style("fill",b.axis.color).style("font-weight",b.axis.fontWeight),a.svg.selectAll(".axis .label").style("fill",b.axis.label.color).style("font-weight",b.axis.label.fontWeight),a.svg.style("font-family",b.fontFamily),a.svg.style("font-size",b.fontSize)}}})}();